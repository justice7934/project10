<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Justic - Library</title>
<link rel="stylesheet" href="css/style.css">

<script>
  const token = localStorage.getItem("access_token");
  if (!token) location.href = "index.html";
</script>

<style>
.video-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.video-modal-center { width: 100%; display: flex; justify-content: center; }
.video-modal-content { display: flex; gap: 36px; }
.short-card { display: flex; flex-direction: column; align-items: center; gap: 14px; }
.short-title { color: #fff; font-size: 14px; opacity: .85; }
.short-video { width: 300px; aspect-ratio: 9/16; background:black; border-radius:14px; overflow:hidden; }
.short-video video { width:100%; height:100%; object-fit:cover; }
.youtube-btn {
  display:flex; gap:10px; align-items:center; justify-content:center;
  background:#fff; border:1px solid #dadce0; border-radius:6px;
  padding:10px 16px; cursor:pointer;
}
.youtube-btn:hover { background:#f7f8f8; }
.youtube-icon { width:20px; height:20px; }
@media(max-width:900px){
  .video-modal-content{ flex-direction:column; align-items:center; }
}
</style>
</head>

<body>

<div class="top-menu">
  <div class="menu-btn" id="menuBtn"><span></span></div>
  <div class="menu-dropdown" id="menuDropdown">
    <a href="#" id="goMainBtn">영상 생성하러 가기</a>
    <a href="#" id="logoutBtn">로그아웃</a>
  </div>
</div>

<div class="library-container">
  <h2 class="library-title">라이브러리</h2>
  <div class="video-grid" id="videoGrid"></div>
</div>

<script>
const videoGrid = document.getElementById("videoGrid");

/* 메뉴 */
menuBtn.onclick = () => menuDropdown.classList.toggle("show");
logoutBtn.onclick = () => { localStorage.removeItem("access_token"); location.href="index.html"; };
goMainBtn.onclick = () => location.href="main.html";
document.addEventListener("click",e=>{
  if(!menuBtn.contains(e.target)&&!menuDropdown.contains(e.target))
    menuDropdown.classList.remove("show");
});

/* 썸네일 */
async function loadThumb(img, taskId){
  try{
    const res = await fetch(`/api/video/thumb/${taskId}.jpg`, {
      headers:{Authorization:`Bearer ${token}`}
    });
    img.src = URL.createObjectURL(await res.blob());
  }catch{
    img.src = "";
  }
}

/* 라이브러리 로드 */
async function loadLibrary(){
  const res = await fetch("/api/video/list",{ headers:{Authorization:`Bearer ${token}`}});
  const data = await res.json();

  if(!data.videos.length){
    videoGrid.innerHTML = `
      <div class="empty-library">
        <div class="empty-main">생성된 영상이 없습니다.</div>
        <div class="empty-sub" id="goCreate">
          영상 생성하러 가기
        </div>
      </div>
    `;

    document.getElementById("goCreate").onclick = () => {
      location.href = "main.html";
    };
    return;
  }


  data.videos.forEach(v=>{
    const card=document.createElement("div");
    card.className="video-card";

    const img=document.createElement("img");
    img.className="thumb-img";
    loadThumb(img,v.task_id);

    card.appendChild(img);
    card.onclick=()=>openPreview(v.task_id);
    videoGrid.appendChild(card);
  });
}

/* 영상 fetch */
async function fetchVideo(taskId,type){
  const res = await fetch(`/api/video/stream/${taskId}?type=${type}`,{
    headers:{Authorization:`Bearer ${token}`}
  });
  if(!res.ok) throw new Error();
  return URL.createObjectURL(await res.blob());
}

/* ===========================
   ✅ 제목 입력 모달 (추가)
=========================== */
function openTitleModal(taskId, type){
  const modal = document.createElement("div");
  modal.className = "title-modal";

  modal.innerHTML = `
    <div class="title-box">
      <h3>YouTube 영상 업로드</h3>
      <input type="text" id="youtubeTitle" placeholder="영상 제목을 입력해주세요">
      <div class="title-actions">
        <button id="cancelBtn">취소</button>
        <button id="confirmBtn">업로드</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector("#cancelBtn").onclick = () => modal.remove();

  modal.querySelector("#confirmBtn").onclick = async () => {
    const title = modal.querySelector("#youtubeTitle").value.trim();
    if(!title){
      alert("제목을 입력해주세요.");
      return;
    }

    try{
      const res = await fetch("/api/video/upload/youtube",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body: JSON.stringify({
          task_id: taskId,
          type: type,
          title: title
        })
      });

      if(!res.ok) throw new Error();
      alert("YouTube 업로드 완료! 채널에서 확인해주세요!");
      modal.remove();
    }catch(e){
      alert("YouTube 채널이 없거나, 업로드에 실패 하였습니다.");
    }
  };
}

/* 쇼츠 */
async function createShort(title,taskId,type){
  const wrap=document.createElement("div");
  wrap.className="short-card";

  const label=document.createElement("div");
  label.className="short-title";
  label.textContent=title;

  const box=document.createElement("div");
  box.className="short-video";

  const video=document.createElement("video");
  video.controls=true;

  try{
    video.src=await fetchVideo(taskId,type);
  }catch{
    label.textContent += " (없음)";
  }

  box.appendChild(video);

  const btn=document.createElement("button");
  btn.className="youtube-btn";
  btn.innerHTML=`
    <img class="youtube-icon"
      src="https://upload.wikimedia.org/wikipedia/commons/f/fd/YouTube_full-color_icon_%282024%29.svg">
    업로드
  `;

  /* ✅ 기존 alert 대신 제목 모달 */
  btn.onclick=()=>openTitleModal(taskId,type);

  wrap.append(label,box,btn);
  return wrap;
}

/* 미리보기 */
async function openPreview(taskId){
  const modal=document.createElement("div");
  modal.className="video-modal";

  const center=document.createElement("div");
  center.className="video-modal-center";

  const content=document.createElement("div");
  content.className="video-modal-content";

  content.appendChild(await createShort("Original",taskId,"original"));

  try{
    content.appendChild(await createShort("Edited",taskId,"processed"));
  }catch{}

  center.appendChild(content);
  modal.appendChild(center);
  document.body.appendChild(modal);

  modal.onclick=()=>modal.remove();
  content.onclick=e=>e.stopPropagation();
}

loadLibrary();
</script>
</body>
</html>

---
# roles/was/tasks/main.yml

# ============================================
# Enable EPEL (필수 유틸용)
# ============================================

- name: Enable EPEL repository
  ansible.builtin.dnf:
    name: epel-release
    state: present


# ============================================
# Install base system packages (❌ ffmpeg 제외)
# ============================================

- name: Install system packages (Python, Redis client, PostgreSQL client)
  ansible.builtin.dnf:
    name:
      - python3
      - python3-pip
      - redis
      - postgresql
      - tar
      - xz
    state: present


# ============================================
# Install ffmpeg (Static Binary 방식 ⭐ 안정화 버전)
# ============================================

- name: Download ffmpeg static binary (robust, no hang)
  ansible.builtin.shell: |
    set -e
    timeout 300 curl -L \
      --retry 5 \
      --retry-delay 5 \
      --fail \
      --silent \
      --show-error \
      -o /tmp/ffmpeg.tar.xz \
      https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
  args:
    creates: /tmp/ffmpeg.tar.xz

- name: Verify ffmpeg archive exists
  ansible.builtin.stat:
    path: /tmp/ffmpeg.tar.xz
  register: ffmpeg_archive

- name: Fail if ffmpeg download failed
  ansible.builtin.fail:
    msg: "ffmpeg download failed or timed out"
  when: not ffmpeg_archive.stat.exists

- name: Extract ffmpeg archive
  ansible.builtin.unarchive:
    src: /tmp/ffmpeg.tar.xz
    dest: /opt
    remote_src: yes

- name: Install ffmpeg binary
  ansible.builtin.shell: |
    set -e
    FFMPEG_DIR=$(find /opt -maxdepth 1 -type d -name "ffmpeg-*-static" | head -n 1)
    cp "$FFMPEG_DIR/ffmpeg" /usr/local/bin/ffmpeg
    chmod +x /usr/local/bin/ffmpeg
  args:
    creates: /usr/local/bin/ffmpeg

- name: Verify ffmpeg installation
  ansible.builtin.command: ffmpeg -version
  changed_when: false


# ============================================
# WAS application directories
# ============================================

- name: Create WAS base directory
  ansible.builtin.file:
    path: /opt/was
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"

- name: Create WAS app directory
  ansible.builtin.file:
    path: /opt/was/app
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"


# ============================================
# Deploy WAS application
# ============================================

- name: Copy WAS application files
  ansible.builtin.copy:
    src: app/
    dest: /opt/was/app/
    owner: ansible
    group: ansible
  notify: restart was

- name: Create Python virtualenv
  ansible.builtin.command: python3 -m venv /opt/was/venv
  args:
    creates: /opt/was/venv/bin/activate

- name: Install Python dependencies
  ansible.builtin.pip:
    requirements: /opt/was/app/requirements.txt
    virtualenv: /opt/was/venv
    virtualenv_python: python3


# ============================================
# Google OAuth / YouTube API
# ============================================

- name: Install Google OAuth & YouTube API libraries
  ansible.builtin.pip:
    name:
      - google-auth
      - google-auth-oauthlib
      - google-auth-httplib2
      - google-api-python-client
    virtualenv: /opt/was/venv
    virtualenv_python: python3


# ============================================
# Environment & systemd
# ============================================

- name: Copy WAS environment file
  ansible.builtin.copy:
    src: was.env
    dest: /etc/was.env
    owner: root
    group: root
    mode: "0600"
  notify: restart was

- name: Install WAS systemd service
  ansible.builtin.template:
    src: was.service.j2
    dest: /etc/systemd/system/was.service
  notify:
    - reload systemd
    - restart was

- name: Enable and start WAS service
  ansible.builtin.systemd:
    name: was
    enabled: yes
    state: started


# ============================================
# Video storage directories (Veo)
# ============================================

- name: Create video base directory
  ansible.builtin.file:
    path: /var/lib/veo
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"

- name: Create video storage directory
  ansible.builtin.file:
    path: /var/lib/veo/videos
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"

- name: Create thumbnail storage directory
  ansible.builtin.file:
    path: /var/lib/veo/thumbs
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"
